//=============================================================================
//
// We need some ECMAScript 5 methods but we need to implement them ourselves
// for older browsers (compatibility: http://kangax.github.com/es5-compat-table/)
//
//  Function.bind:        https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function/bind
//  Object.create:        http://javascript.crockford.com/prototypal.html
//  Object.extend:        (defacto standard like jquery $.extend or prototype's Object.extend)
//
//  Object.construct:     our own wrapper around Object.create that ALSO calls
//                        an initialize constructor method if one exists
//
//=============================================================================
Function.prototype.bind||(Function.prototype.bind=function(e){var t=[].slice,n=t.call(arguments,1),r=this,i=function(){},s=function(){return r.apply(this instanceof i?this:e||{},n.concat(t.call(arguments)))};i.prototype=r.prototype;s.prototype=new i;return s});Object.create||(Object.create=function(e){function t(){}t.prototype=e;return new t});Object.construct||(Object.construct=function(e){var t=Object.create(e);t.initialize&&t.initialize.apply(t,[].slice.call(arguments,1));return t});Object.extend||(Object.extend=function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e});Game={compatible:function(){return Object.create&&Object.extend&&Function.bind&&document.addEventListener&&Game.ua.hasCanvas},start:function(e,t,n){if(Game.compatible())return Object.construct(Game.Runner,e,t,n).game},ua:function(){var e=navigator.userAgent.toLowerCase(),t=e.indexOf("opera")>-1?"opera":null;t=t||(e.indexOf("firefox")>-1?"firefox":null);t=t||(e.indexOf("chrome")>-1?"chrome":null);t=t||(e.indexOf("safari")>-1?"safari":null);t=t||(e.indexOf("msie")>-1?"ie":null);try{var n=t=="ie"?"msie (\\d)":t+"\\/(\\d\\.\\d)",r=e.match(new RegExp(n,"i")),i=r?parseFloat(r[1]):null}catch(s){}return{full:e,name:t+(i?" "+i.toString():""),version:i,isFirefox:t=="firefox",isChrome:t=="chrome",isSafari:t=="safari",isOpera:t=="opera",isIE:t=="ie",hasCanvas:document.createElement("canvas").getContext,hasAudio:typeof Audio!="undefined"}}(),addEvent:function(e,t,n){e.addEventListener(t,n,!1)},removeEvent:function(e,t,n){e.removeEventListener(t,n,!1)},ready:function(e){Game.compatible()&&Game.addEvent(document,"DOMContentLoaded",e)},createCanvas:function(){return document.createElement("canvas")},createAudio:function(e){try{var t=new Audio(e);t.volume=.1;return t}catch(n){return null}},loadImages:function(e,t){var n={},r=e?e.length:0;if(r==0)t(n);else for(var i=0;i<e.length;i++){var s=e[i],o=document.createElement("img");n[s]=o;Game.addEvent(o,"load",function(){--r==0&&t(n)});o.src=s}},random:function(e,t){return e+Math.random()*(t-e)},timestamp:function(){return(new Date).getTime()},KEY:{BACKSPACE:8,TAB:9,RETURN:13,ESC:27,SPACE:32,LEFT:37,UP:38,RIGHT:39,DOWN:40,DELETE:46,HOME:36,END:35,PAGEUP:33,PAGEDOWN:34,INSERT:45,ZERO:48,ONE:49,TWO:50,A:65,L:76,P:80,Q:81,TILDA:192},Runner:{initialize:function(e,t,n){this.cfg=Object.extend(t.Defaults||{},n||{});this.fps=this.cfg.fps||60;this.interval=1e3/this.fps;this.canvas=document.getElementById(e);this.width=this.cfg.width||this.canvas.offsetWidth;this.height=this.cfg.height||this.canvas.offsetHeight;this.front=this.canvas;this.front.width=this.width;this.front.height=this.height;this.back=Game.createCanvas();this.back.width=this.width;this.back.height=this.height;this.front2d=this.front.getContext("2d");this.back2d=this.back.getContext("2d");this.addEvents();this.resetStats();this.game=Object.construct(t,this,this.cfg)},start:function(){this.lastFrame=Game.timestamp();this.timer=setInterval(this.loop.bind(this),this.interval)},stop:function(){clearInterval(this.timer)},loop:function(){var e=Game.timestamp();this.update((e-this.lastFrame)/1e3);var t=Game.timestamp();this.draw();var n=Game.timestamp();this.updateStats(t-e,n-t);this.lastFrame=e},update:function(e){this.game.update(e)},draw:function(){this.back2d.clearRect(0,0,this.width,this.height);this.game.draw(this.back2d);this.drawStats(this.back2d);this.front2d.clearRect(0,0,this.width,this.height);this.front2d.drawImage(this.back,0,0)},resetStats:function(){this.stats={count:0,fps:0,update:0,draw:0,frame:0}},updateStats:function(e,t){if(this.cfg.stats){this.stats.update=Math.max(1,e);this.stats.draw=Math.max(1,t);this.stats.frame=this.stats.update+this.stats.draw;this.stats.count=this.stats.count==this.fps?0:this.stats.count+1;this.stats.fps=Math.min(this.fps,1e3/this.stats.frame)}},drawStats:function(e){if(this.cfg.stats){e.fillText("frame: "+this.stats.count,this.width-100,this.height-60);e.fillText("fps: "+this.stats.fps,this.width-100,this.height-50);e.fillText("update: "+this.stats.update+"ms",this.width-100,this.height-40);e.fillText("draw: "+this.stats.draw+"ms",this.width-100,this.height-30)}},addEvents:function(){Game.addEvent(document,"keydown",this.onkeydown.bind(this));Game.addEvent(document,"keyup",this.onkeyup.bind(this))},onkeydown:function(e){this.game.onkeydown&&this.game.onkeydown(e.keyCode)},onkeyup:function(e){this.game.onkeyup&&this.game.onkeyup(e.keyCode)},hideCursor:function(){this.canvas.style.cursor="none"},showCursor:function(){this.canvas.style.cursor="auto"},alert:function(e){this.stop();result=window.alert(e);this.start();return result},confirm:function(e){this.stop();result=window.confirm(e);this.start();return result}}};