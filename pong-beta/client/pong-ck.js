//=============================================================================
// PONG
//=============================================================================
Pong={Defaults:{width:640,height:480,wallWidth:12,paddleWidth:12,paddleHeight:60,paddleSpeed:2,ballSpeed:4,ballAccel:8,ballRadius:5,sound:!0},Colors:{walls:"white",ball:"white",score:"white",footprint:"#333",predictionGuess:"yellow",predictionExact:"red"},Images:["images/press1.png","images/press2.png","images/winner.png"],Levels:[{aiReaction:.2,aiError:40},{aiReaction:.3,aiError:50},{aiReaction:.4,aiError:60},{aiReaction:.5,aiError:70},{aiReaction:.6,aiError:80},{aiReaction:.7,aiError:90},{aiReaction:.8,aiError:100},{aiReaction:.9,aiError:110},{aiReaction:1,aiError:120},{aiReaction:1.1,aiError:130},{aiReaction:1.2,aiError:140},{aiReaction:1.3,aiError:150},{aiReaction:1.4,aiError:160},{aiReaction:1.5,aiError:170},{aiReaction:1.6,aiError:180},{aiReaction:1.7,aiError:190},{aiReaction:1.8,aiError:200}],initialize:function(e,t){Game.loadImages(Pong.Images,function(n){this.cfg=t;this.runner=e;this.width=e.width;this.height=e.height;this.images=n;this.playing=!1;this.scores=[0,0];this.menu=Object.construct(Pong.Menu,this);this.court=Object.construct(Pong.Court,this);this.leftPaddle=Object.construct(Pong.Paddle,this);this.rightPaddle=Object.construct(Pong.Paddle,this,!0);this.ball=Object.construct(Pong.Ball,this);this.sounds=Object.construct(Pong.Sounds,this);this.runner.start()}.bind(this))},startDemo:function(){this.start(0)},startSinglePlayer:function(){this.start(1)},startDoublePlayer:function(){this.start(2)},start:function(e){if(!this.playing){this.scores=[0,0];this.playing=!0;this.leftPaddle.setAuto(e<1,this.level(0));this.rightPaddle.setAuto(e<2,this.level(1));this.ball.reset();this.runner.hideCursor()}},stop:function(e){if(this.playing)if(!e||this.runner.confirm("Abandon game in progress ?")){this.playing=!1;this.leftPaddle.setAuto(!1);this.rightPaddle.setAuto(!1);this.runner.showCursor()}},level:function(e){return 8+(this.scores[e]-this.scores[e?0:1])},goal:function(e){this.sounds.goal();this.scores[e]+=1;if(this.scores[e]==9){this.menu.declareWinner(e);this.stop()}else{this.ball.reset(e);this.leftPaddle.setLevel(this.level(0));this.rightPaddle.setLevel(this.level(1))}},update:function(e){this.leftPaddle.update(e,this.ball);this.rightPaddle.update(e,this.ball);if(this.playing){var t=this.ball.dx,n=this.ball.dy;this.ball.update(e,this.leftPaddle,this.rightPaddle);this.ball.dx<0&&t>0?this.sounds.ping():this.ball.dx>0&&t<0?this.sounds.pong():this.ball.dy*n<0&&this.sounds.wall();this.ball.left>this.width?this.goal(0):this.ball.right<0&&this.goal(1)}},draw:function(e){this.court.draw(e,this.scores[0],this.scores[1]);this.leftPaddle.draw(e);this.rightPaddle.draw(e);this.playing?this.ball.draw(e):this.menu.draw(e)},onkeydown:function(e){switch(e){case Game.KEY.ZERO:this.startDemo();break;case Game.KEY.ONE:this.startSinglePlayer();break;case Game.KEY.TWO:this.startDoublePlayer();break;case Game.KEY.ESC:this.stop(!0);break;case Game.KEY.Q:this.leftPaddle.auto||this.leftPaddle.moveUp();break;case Game.KEY.A:this.leftPaddle.auto||this.leftPaddle.moveDown();break;case Game.KEY.P:this.rightPaddle.auto||this.rightPaddle.moveUp();break;case Game.KEY.L:this.rightPaddle.auto||this.rightPaddle.moveDown()}},onkeyup:function(e){switch(e){case Game.KEY.Q:this.leftPaddle.auto||this.leftPaddle.stopMovingUp();break;case Game.KEY.A:this.leftPaddle.auto||this.leftPaddle.stopMovingDown();break;case Game.KEY.P:this.rightPaddle.auto||this.rightPaddle.stopMovingUp();break;case Game.KEY.L:this.rightPaddle.auto||this.rightPaddle.stopMovingDown()}},showStats:function(e){this.cfg.stats=e},showFootprints:function(e){this.cfg.footprints=e;this.ball.footprints=[]},showPredictions:function(e){this.cfg.predictions=e},enableSound:function(e){this.cfg.sound=e},Menu:{initialize:function(e){var t=e.images["images/press1.png"],n=e.images["images/press2.png"],r=e.images["images/winner.png"];this.press1={image:t,x:10,y:e.cfg.wallWidth};this.press2={image:n,x:e.width-n.width-10,y:e.cfg.wallWidth};this.winner1={image:r,x:e.width/2-r.width-e.cfg.wallWidth,y:6*e.cfg.wallWidth};this.winner2={image:r,x:e.width/2+e.cfg.wallWidth,y:6*e.cfg.wallWidth}},declareWinner:function(e){this.winner=e},draw:function(e){e.drawImage(this.press1.image,this.press1.x,this.press1.y);e.drawImage(this.press2.image,this.press2.x,this.press2.y);this.winner==0?e.drawImage(this.winner1.image,this.winner1.x,this.winner1.y):this.winner==1&&e.drawImage(this.winner2.image,this.winner2.x,this.winner2.y)}},Sounds:{initialize:function(e){this.game=e;this.supported=Game.ua.hasAudio;this.supported&&(this.files={ping:Game.createAudio("sounds/ping.wav"),pong:Game.createAudio("sounds/pong.wav"),wall:Game.createAudio("sounds/wall.wav"),goal:Game.createAudio("sounds/goal.wav")})},play:function(e){this.supported&&this.game.cfg.sound&&this.files[e]&&this.files[e].play()},ping:function(){this.play("ping")},pong:function(){this.play("pong")},wall:function(){this.play("wall")},goal:function(){this.play("goal")}},Court:{initialize:function(e){var t=e.width,n=e.height,r=e.cfg.wallWidth;this.ww=r;this.walls=[];this.walls.push({x:0,y:0,width:t,height:r});this.walls.push({x:0,y:n-r,width:t,height:r});var i=n/(r*2);for(var s=0;s<i;s++)this.walls.push({x:t/2-r/2,y:r/2+r*2*s,width:r,height:r});var o=3*r,u=4*r;this.score1={x:.5+t/2-1.5*r-o,y:2*r,w:o,h:u};this.score2={x:.5+t/2+1.5*r,y:2*r,w:o,h:u}},draw:function(e,t,n){e.fillStyle=Pong.Colors.walls;for(var r=0;r<this.walls.length;r++)e.fillRect(this.walls[r].x,this.walls[r].y,this.walls[r].width,this.walls[r].height);this.drawDigit(e,t,this.score1.x,this.score1.y,this.score1.w,this.score1.h);this.drawDigit(e,n,this.score2.x,this.score2.y,this.score2.w,this.score2.h)},drawDigit:function(e,t,n,r,i,s){e.fillStyle=Pong.Colors.score;var o=dh=this.ww*4/5,u=Pong.Court.DIGITS[t];u[0]&&e.fillRect(n,r,i,dh);u[1]&&e.fillRect(n,r,o,s/2);u[2]&&e.fillRect(n+i-o,r,o,s/2);u[3]&&e.fillRect(n,r+s/2-dh/2,i,dh);u[4]&&e.fillRect(n,r+s/2,o,s/2);u[5]&&e.fillRect(n+i-o,r+s/2,o,s/2);u[6]&&e.fillRect(n,r+s-dh,i,dh)},DIGITS:[[1,1,1,0,1,1,1],[0,0,1,0,0,1,0],[1,0,1,1,1,0,1],[1,0,1,1,0,1,1],[0,1,1,1,0,1,0],[1,1,0,1,0,1,1],[1,1,0,1,1,1,1],[1,0,1,0,0,1,0],[1,1,1,1,1,1,1],[1,1,1,1,0,1,0]]},Paddle:{initialize:function(e,t){this.pong=e;this.width=e.cfg.paddleWidth;this.height=e.cfg.paddleHeight;this.minY=e.cfg.wallWidth;this.maxY=e.height-e.cfg.wallWidth-this.height;this.speed=(this.maxY-this.minY)/e.cfg.paddleSpeed;this.setpos(t?e.width-this.width:0,this.minY+(this.maxY-this.minY)/2);this.setdir(0)},setpos:function(e,t){this.x=e;this.y=t;this.left=this.x;this.right=this.left+this.width;this.top=this.y;this.bottom=this.y+this.height},setdir:function(e){this.up=e<0?-e:0;this.down=e>0?e:0},setAuto:function(e,t){if(e&&!this.auto){this.auto=!0;this.setLevel(t)}else if(!e&&this.auto){this.auto=!1;this.setdir(0)}},setLevel:function(e){this.auto&&(this.level=Pong.Levels[e])},update:function(e,t){this.auto&&this.ai(e,t);var n=this.down-this.up;if(n!=0){var r=this.y+n*e*this.speed;r<this.minY?r=this.minY:r>this.maxY&&(r=this.maxY);this.setpos(this.x,r)}},ai:function(e,t){if(t.x<this.left&&t.dx<0||t.x>this.right&&t.dx>0){this.stopMovingUp();this.stopMovingDown();return}this.predict(t,e);if(this.prediction)if(this.prediction.y<this.top+this.height/2-5){this.stopMovingDown();this.moveUp()}else if(this.prediction.y>this.bottom-this.height/2+5){this.stopMovingUp();this.moveDown()}else{this.stopMovingUp();this.stopMovingDown()}},predict:function(e,t){if(this.prediction&&this.prediction.dx*e.dx>0&&this.prediction.dy*e.dy>0&&this.prediction.since<this.level.aiReaction){this.prediction.since+=t;return}var n=Pong.Helper.ballIntercept(e,{left:this.left,right:this.right,top:-1e4,bottom:1e4},e.dx*10,e.dy*10);if(n){var r=this.minY+e.radius,i=this.maxY+this.height-e.radius;while(n.y<r||n.y>i)n.y<r?n.y=r+(r-n.y):n.y>i&&(n.y=r+(i-r)-(n.y-i));this.prediction=n}else this.prediction=null;if(this.prediction){this.prediction.since=0;this.prediction.dx=e.dx;this.prediction.dy=e.dy;this.prediction.radius=e.radius;this.prediction.exactX=this.prediction.x;this.prediction.exactY=this.prediction.y;var s=(e.dx<0?e.x-this.right:this.left-e.x)/this.pong.width,o=this.level.aiError*s;this.prediction.y=this.prediction.y+Game.random(-o,o)}},draw:function(e){e.fillStyle=Pong.Colors.walls;e.fillRect(this.x,this.y,this.width,this.height);if(this.prediction&&this.pong.cfg.predictions){e.strokeStyle=Pong.Colors.predictionExact;e.strokeRect(this.prediction.x-this.prediction.radius,this.prediction.exactY-this.prediction.radius,this.prediction.radius*2,this.prediction.radius*2);e.strokeStyle=Pong.Colors.predictionGuess;e.strokeRect(this.prediction.x-this.prediction.radius,this.prediction.y-this.prediction.radius,this.prediction.radius*2,this.prediction.radius*2)}},moveUp:function(){this.up=1},moveDown:function(){this.down=1},stopMovingUp:function(){this.up=0},stopMovingDown:function(){this.down=0}},Ball:{initialize:function(e){this.pong=e;this.radius=e.cfg.ballRadius;this.minX=this.radius;this.maxX=e.width-this.radius;this.minY=e.cfg.wallWidth+this.radius;this.maxY=e.height-e.cfg.wallWidth-this.radius;this.speed=(this.maxX-this.minX)/e.cfg.ballSpeed;this.accel=e.cfg.ballAccel},reset:function(e){this.footprints=[];this.setpos(e==1?this.maxX:this.minX,Game.random(this.minY,this.maxY));this.setdir(e==1?-this.speed:this.speed,this.speed)},setpos:function(e,t){this.x=e;this.y=t;this.left=this.x-this.radius;this.top=this.y-this.radius;this.right=this.x+this.radius;this.bottom=this.y+this.radius},setdir:function(e,t){this.dxChanged=this.dx<0!=e<0;this.dyChanged=this.dy<0!=t<0;this.dx=e;this.dy=t},footprint:function(){if(this.pong.cfg.footprints)if(!this.footprintCount||this.dxChanged||this.dyChanged){this.footprints.push({x:this.x,y:this.y});this.footprints.length>50&&this.footprints.shift();this.footprintCount=5}else this.footprintCount--},update:function(e,t,n){pos=Pong.Helper.accelerate(this.x,this.y,this.dx,this.dy,this.accel,e);if(pos.dy>0&&pos.y>this.maxY){pos.y=this.maxY;pos.dy=-pos.dy}else if(pos.dy<0&&pos.y<this.minY){pos.y=this.minY;pos.dy=-pos.dy}var r=pos.dx<0?t:n,i=Pong.Helper.ballIntercept(this,r,pos.nx,pos.ny);if(i){switch(i.d){case"left":case"right":pos.x=i.x;pos.dx=-pos.dx;break;case"top":case"bottom":pos.y=i.y;pos.dy=-pos.dy}r.up?pos.dy=pos.dy*(pos.dy<0?.5:1.5):r.down&&(pos.dy=pos.dy*(pos.dy>0?.5:1.5))}this.setpos(pos.x,pos.y);this.setdir(pos.dx,pos.dy);this.footprint()},draw:function(e){var t=h=this.radius*2;e.fillStyle=Pong.Colors.ball;e.fillRect(this.x-this.radius,this.y-this.radius,t,h);if(this.pong.cfg.footprints){var n=this.footprints.length;e.strokeStyle=Pong.Colors.footprint;for(var r=0;r<n;r++)e.strokeRect(this.footprints[r].x-this.radius,this.footprints[r].y-this.radius,t,h)}}},Helper:{accelerate:function(e,t,n,r,i,s){var o=e+s*n+i*s*s*.5,u=t+s*r+i*s*s*.5,a=n+i*s*(n>0?1:-1),f=r+i*s*(r>0?1:-1);return{nx:o-e,ny:u-t,x:o,y:u,dx:a,dy:f}},intercept:function(e,t,n,r,i,s,o,u,a){var f=(u-s)*(n-e)-(o-i)*(r-t);if(f!=0){var l=((o-i)*(t-s)-(u-s)*(e-i))/f;if(l>=0&&l<=1){var c=((n-e)*(t-s)-(r-t)*(e-i))/f;if(c>=0&&c<=1){var h=e+l*(n-e),p=t+l*(r-t);return{x:h,y:p,d:a}}}}return null},ballIntercept:function(e,t,n,r){var i;n<0?i=Pong.Helper.intercept(e.x,e.y,e.x+n,e.y+r,t.right+e.radius,t.top-e.radius,t.right+e.radius,t.bottom+e.radius,"right"):n>0&&(i=Pong.Helper.intercept(e.x,e.y,e.x+n,e.y+r,t.left-e.radius,t.top-e.radius,t.left-e.radius,t.bottom+e.radius,"left"));i||(r<0?i=Pong.Helper.intercept(e.x,e.y,e.x+n,e.y+r,t.left-e.radius,t.bottom+e.radius,t.right+e.radius,t.bottom+e.radius,"bottom"):r>0&&(i=Pong.Helper.intercept(e.x,e.y,e.x+n,e.y+r,t.left-e.radius,t.top-e.radius,t.right+e.radius,t.top-e.radius,"top")));return i}}};